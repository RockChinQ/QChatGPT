QChatGPT æ’ä»¶å¼€å‘Wiki

> è¯·å…ˆé˜…è¯»[æ’ä»¶ä½¿ç”¨é¡µ](https://github.com/RockChinQ/QChatGPT/wiki/%E6%8F%92%E4%BB%B6%E4%BD%BF%E7%94%A8)  
> è¯·å…ˆé˜…è¯»[æŠ€æœ¯ä¿¡æ¯é¡µ](https://github.com/RockChinQ/QChatGPT/wiki/%E6%8A%80%E6%9C%AF%E4%BF%A1%E6%81%AF)  
> å»ºè®®å…ˆé˜…è¯»æœ¬é¡¹ç›®æºç ï¼Œäº†è§£é¡¹ç›®æ¶æ„

> é—®é¢˜ã€éœ€æ±‚è¯·åˆ°ä»“åº“issueå‘èµ·  
> **æé—®å‰è¯·å…ˆé è‡ªå·±å°è¯•** 

## ğŸ’¬ç®€ä»‹

å°½ç®¡â€œä¸ºä¸€ä¸ªåŸºäºOpenAI APIçš„QQæœºå™¨äººå¼€å‘æ’ä»¶æ”¯æŒâ€è¿™äº‹çœ‹èµ·æ¥æœ‰ç‚¹å°é¢˜å¤§åšï¼Œä½†èŒç”Ÿæ­¤æƒ³æ³•åçš„å‡ å¤©å†…å¥½å‡ ä¸ªäººæå‡ºäº†è¿™ä¸ªéœ€æ±‚ï¼Œæœ€ç»ˆä¿ƒä½¿æ­¤é¡¹ç›®æ­£å¼æ”¯æŒæ’ä»¶ã€‚

## ğŸ§±å®ç°

åŸºäº`importlib`åº“åŠ è½½æ¨¡å—çš„æ–¹æ³•åŠ¨æ€åŠ è½½é¢å¤–Pythonç¨‹åºæ–‡ä»¶ä»¥ä¾¿å®ç°æ’ä»¶åŠ è½½ï¼Œæ’ä»¶å‡å­˜æ”¾åœ¨`plugins`æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­çš„æ‰€æœ‰`.py`æ–‡ä»¶éƒ½å°†è¢«åŠ è½½(é™¤äº†æ‰€æœ‰`__init__.py`)

## ğŸ“šç¤ºä¾‹ä»£ç 

è¯·æŸ¥çœ‹ä»£ç ç›®å½•`tests/plugin_examples`ä¸­çš„æ’ä»¶ç›®å½•

## ğŸ’»å¿«é€Ÿå¼€å§‹

æŒ‰ç…§æ–‡æ¡£éƒ¨ç½²æ­¤é¡¹ç›®ï¼Œå¹¶ä½¿å…¶æ­£å¸¸è¿è¡Œã€‚  
åœ¨`plugins`ç›®å½•ä¸‹æ–°å»ºç›®å½•`hello`ï¼Œåœ¨å…¶ä¸­æ–°å»ºç©ºæ–‡ä»¶`__init__.py`ä»¥æ ‡è®°æ­¤ç›®å½•ä¸ºè½¯ä»¶åŒ…ï¼Œç»§ç»­æ–°å»ºæ–‡ä»¶`main.py`ã€‚  

> æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨[hello_plugin](https://github.com/RockChinQ/hello_plugin)ä½œä¸ºæ¨¡æ¿ç›´æ¥ç”Ÿæˆæ’ä»¶ä»£ç ä»“åº“

ç¼–è¾‘`main.py`è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š

```Python
from pkg.plugin.models import *
from pkg.plugin.host import EventContext, PluginHost

"""
åœ¨æ”¶åˆ°ç§èŠæˆ–ç¾¤èŠæ¶ˆæ¯"hello"æ—¶ï¼Œå›å¤"hello, <å‘é€è€…id>!"æˆ–"hello, everyone!"
"""


# æ³¨å†Œæ’ä»¶
@register(name="Hello", description="hello world", version="0.1", author="RockChinQ")
class HelloPlugin(Plugin):

    # æ’ä»¶åŠ è½½æ—¶è§¦å‘
    # plugin_host (pkg.plugin.host.PluginHost) æä¾›äº†ä¸ä¸»ç¨‹åºäº¤äº’çš„ä¸€äº›æ–¹æ³•ï¼Œè¯¦ç»†è¯·æŸ¥çœ‹å…¶æºç 
    def __init__(self, plugin_host: PluginHost):
        pass

    # å½“æ”¶åˆ°ä¸ªäººæ¶ˆæ¯æ—¶è§¦å‘
    @on(PersonNormalMessageReceived)
    def person_normal_message_received(self, event: EventContext, **kwargs):
        msg = kwargs['text_message']
        if msg == "hello":  # å¦‚æœæ¶ˆæ¯ä¸ºhello

            # è¾“å‡ºè°ƒè¯•ä¿¡æ¯
            logging.debug("hello, {}".format(kwargs['sender_id']))

            # å›å¤æ¶ˆæ¯ "hello, <å‘é€è€…id>!"
            event.add_return("reply", ["hello, {}!".format(kwargs['sender_id'])])

            # é˜»æ­¢è¯¥äº‹ä»¶é»˜è®¤è¡Œä¸ºï¼ˆå‘æ¥å£è·å–å›å¤ï¼‰
            event.prevent_default()

    # å½“æ”¶åˆ°ç¾¤æ¶ˆæ¯æ—¶è§¦å‘
    @on(GroupNormalMessageReceived)
    def group_normal_message_received(self, event: EventContext, **kwargs):
        msg = kwargs['text_message']
        if msg == "hello":  # å¦‚æœæ¶ˆæ¯ä¸ºhello

            # è¾“å‡ºè°ƒè¯•ä¿¡æ¯
            logging.debug("hello, {}".format(kwargs['sender_id']))

            # å›å¤æ¶ˆæ¯ "hello, everyone!"
            event.add_return("reply", ["hello, everyone!"])

            # é˜»æ­¢è¯¥äº‹ä»¶é»˜è®¤è¡Œä¸ºï¼ˆå‘æ¥å£è·å–å›å¤ï¼‰
            event.prevent_default()

    # æ’ä»¶å¸è½½æ—¶è§¦å‘
    def __del__(self):
        pass

```

æ­¤æ’ä»¶å°†å®ç°ï¼šç§èŠæ”¶åˆ°`hello`æ¶ˆæ¯æ—¶å›å¤`hello, <å‘é€è€…QQå·>!`ï¼Œç¾¤èŠæ”¶åˆ°`hello`æ¶ˆæ¯æ—¶å›å¤`hello, everyone!`

### è§£è¯»æ­¤æ’ä»¶ç¨‹åº

- `import`ä»`pkg.plugin`å¼•å…¥`models`æ¨¡å—çš„æ‰€æœ‰å­—æ®µï¼ˆæ­¤ç¨‹åºä½¿ç”¨äº†å…¶ä¸­çš„`registerå‡½æ•°`ã€`onå‡½æ•°`ã€`Pluginç±»`ã€`PersonNormalMessageReceivedäº‹ä»¶`ã€`GroupNormalMessageReceivedäº‹ä»¶`ï¼‰
- `@register()`å°†ç±»`HelloPlugin`æ ‡è®°ä¸ºä¸€ä¸ªæ’ä»¶ç±»ï¼Œå£°æ˜æ’ä»¶åç§°ä¸º`Hello`ä»¥åŠæ’ä»¶ç®€ä»‹ã€ç‰ˆæœ¬ã€ä½œè€…
- å£°æ˜ç±»`HelloPlugin`ç»§æ‰¿äº`Plugin`ï¼Œæ­¤ç±»å¯ä»¥éšæ„å‘½åï¼Œæ’ä»¶åç§°åªä¸`register`è°ƒç”¨æ—¶çš„å‚æ•°æœ‰å…³
- å£°æ˜æ­¤ç±»çš„`__init__`æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æ˜¯å¯é€‰çš„ï¼Œå…¶ä¸­çš„ä»£ç å°†åœ¨ä¸»ç¨‹åºå¯åŠ¨æ—¶åŠ è½½æ’ä»¶çš„æ—¶å€™è¢«æ‰§è¡Œ
- `@on`å°†æ–¹æ³•`person_normal_message_received`æ ‡è®°ä¸ºä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ï¼Œå¤„ç†`PersonNormalMessageReceived`ï¼ˆæ”¶åˆ°ç§èŠæ¶ˆæ¯å¹¶åœ¨è·å–OpenAIå›å¤å‰è§¦å‘ï¼‰äº‹ä»¶ï¼Œæ­¤æ–¹æ³•å¯ä»¥éšæ„å‘½åï¼Œç»‘å®šçš„äº‹ä»¶åªä¸`on`ä¸­çš„å‚æ•°æœ‰å…³ï¼Œæ›´å¤šæ”¯æŒçš„äº‹ä»¶å¯åˆ°`pkg.plugin.models.py`æ–‡ä»¶ä¸­æŸ¥çœ‹æˆ–æŸ¥çœ‹ä¸‹æ–¹`API`èŠ‚
- è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼Œç¨‹åºä¸­å¯é€šè¿‡`logging`å°†æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°å’Œ`qchatgpt.log`æ–‡ä»¶
- æ–¹æ³•å†…éƒ¨ä»å‚æ•°ä¸­å–å‡º`text_message`å‚æ•°ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º`hello`ï¼Œå¦‚æœæ˜¯å°±å°†è¿”å›å€¼`reply`è®¾ç½®ä¸º`["hello, {}!".format(kwargs['sender_id'])]`ï¼Œæ¥ä¸‹æ¥è°ƒç”¨`event`å¯¹è±¡çš„`prevent_default`æ–¹æ³•ï¼Œé˜»æ­¢åŸç¨‹åºé»˜è®¤è¡Œä¸º
    - æ¯ä¸ªäº‹ä»¶`æä¾›çš„å‚æ•°`å’Œ`æ”¯æŒçš„è¿”å›å€¼`è¯·æŸ¥çœ‹`pkg.plugin.models`ä¸­çš„æ¯ä¸ªäº‹ä»¶çš„æ³¨é‡Šæˆ–æŸ¥çœ‹ä¸‹æ–¹`API`èŠ‚
    - `event`å¯¹è±¡æä¾›çš„æ–¹æ³•è¯·æŸ¥çœ‹`pkg.plugin.host`ä¸­çš„`EventContext`ç±»æˆ–æŸ¥çœ‹ä¸‹æ–¹`API`èŠ‚
- ç”¨ç›¸ä¼¼çš„ç¨‹åºæ³¨å†Œ`GroupNormalMessageReceived`äº‹ä»¶å¤„ç†ç¾¤æ¶ˆæ¯

ç¼–å†™å®Œæ¯•ä¿å­˜åï¼Œé‡æ–°å¯åŠ¨ä¸»ç¨‹åºï¼ŒæŸ¥çœ‹åˆ°è¾“å‡ºä¸­åŒ…å«ä»¥ä¸‹å†…å®¹ï¼Œå³ä¸ºåŠ è½½æˆåŠŸï¼š

```
[2023-01-16 18:29:47.193] host.py (43) - [INFO] : åŠ è½½æ¨¡å—: hello.main
[2023-01-16 18:29:47.194] models.py (209) - [INFO] : æ’ä»¶æ³¨å†Œå®Œæˆ: n='Hello', d='hello world', v=0.1, a='RockChinQ' (<class 'plugins.hello.main.HelloPlugin'>)
```

> å»ºè®®åœ¨`config.py`ä¸­è®¾ç½®`logging_level = logging.DEBUG`ä»¥ä¾¿å¼€å¯è°ƒè¯•è¾“å‡º

## â—è§„èŒƒ(é‡è¦)

- è¯·æ¯ä¸ªæ’ä»¶ç‹¬ç«‹ä¸€ä¸ªç›®å½•ä»¥ä¾¿ç®¡ç†ï¼Œå»ºè®®åœ¨Githubä¸Šåˆ›å»ºä¸€ä¸ªä»“åº“å‚¨å­˜å•ä¸ªæ’ä»¶ï¼Œä»¥ä¾¿è·å–å’Œæ›´æ–°
- æ’ä»¶åä½¿ç”¨`å¤§é©¼å³°å‘½åæ³•`ï¼Œå¦‚`Hello`ã€`ExamplePlugin`ã€`ChineseCommands`ç­‰
- ä¸€ä¸ªç›®å½•å†…å¯ä»¥å­˜æ”¾å¤šä¸ªPythonç¨‹åºæ–‡ä»¶ï¼Œä»¥ç‹¬ç«‹å‡ºæ’ä»¶çš„å„ä¸ªåŠŸèƒ½ï¼Œä¾¿äºå¼€å‘è€…ç®¡ç†ï¼Œä½†ä¸å»ºè®®åœ¨ä¸€ä¸ªç›®å½•å†…æ³¨å†Œå¤šä¸ªæ’ä»¶
- æ’ä»¶éœ€è¦çš„ä¾èµ–åº“è¯·åœ¨æ’ä»¶ç›®å½•ä¸‹çš„`requirements.txt`ä¸­æŒ‡å®šï¼Œç¨‹åºä»å‚¨å­˜åº“è·å–æ­¤æ’ä»¶æ—¶å°†è‡ªåŠ¨å®‰è£…ä¾èµ–

## ğŸªå†…å®¹å‡½æ•°

é€šè¿‡[GPTçš„Function Callingèƒ½åŠ›](https://platform.openai.com/docs/guides/gpt/function-calling)å®ç°çš„`å†…å®¹å‡½æ•°`ï¼Œè¿™æ˜¯ä¸€ç§åµŒå…¥å¯¹è¯ä¸­ï¼Œç”±GPTè‡ªåŠ¨è°ƒç”¨çš„å‡½æ•°ã€‚

> æ‚¨çš„æ’ä»¶æ¯”ä¸€å®šå¿…é¡»åŒ…å«å†…å®¹å‡½æ•°ï¼Œè¯·å…ˆæŸ¥çœ‹å†…å®¹å‡½æ•°é¡µäº†è§£æ­¤åŠŸèƒ½

<details>
<summary>ç¤ºä¾‹ï¼šè”ç½‘æ’ä»¶</summary>

åŠ è½½å«æœ‰è”ç½‘åŠŸèƒ½çš„å†…å®¹å‡½æ•°çš„æ’ä»¶[WebwlkrPlugin](https://github.com/RockChinQ/WebwlkrPlugin)ï¼Œå‘æœºå™¨äººè¯¢é—®åœ¨çº¿å†…å®¹

```
# æ§åˆ¶å°è¾“å‡º
[2023-07-29 17:37:18.698] message.py (26) - [INFO] : [person_1010553892]å‘é€æ¶ˆæ¯:ä»‹ç»ä¸€ä¸‹è¿™ä¸ªé¡¹ç›®ï¼šhttps://git...
[2023-07-29 17:37:21.292] util.py (67) - [INFO] : message='OpenAI API response' path=https://api.openai.com/v1/chat/completions processing_ms=1902 request_id=941afc13b2e1bba1e7877b92a970cdea response_code=200
[2023-07-29 17:37:21.293] chat_completion.py (159) - [INFO] : æ‰§è¡Œå‡½æ•°è°ƒç”¨: name=Webwlkr-access_the_web, arguments={'url': 'https://github.com/RockChinQ/QChatGPT', 'brief_len': 512}
[2023-07-29 17:37:21.848] chat_completion.py (164) - [INFO] : å‡½æ•°æ‰§è¡Œå®Œæˆã€‚
```

![Webwlkræ’ä»¶](https://github.com/RockChinQ/QChatGPT/blob/master/res/screenshots/webwlkr_plugin.png?raw=true)

</details>

### å†…å®¹å‡½æ•°ç¼–å†™æ­¥éª¤

1ï¸âƒ£ è¯·å…ˆæŒ‰ç…§ä¸Šæ–¹æ­¥éª¤ç¼–å†™æ‚¨çš„æ’ä»¶åŸºç¡€ç»“æ„ï¼Œç°åœ¨è¯·åˆ é™¤ï¼ˆå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¸åˆ ï¼Œåªæ˜¯ä¸ºäº†ç®€æ´ï¼‰ä¸Šè¿°æ’ä»¶å†…å®¹çš„è¯¸ä¸ªç”±`@on`è£…é¥°çš„ç±»å‡½æ•°

<details>
<summary>åˆ é™¤åçš„ç»“æ„</summary>

```python
from pkg.plugin.models import *
from pkg.plugin.host import EventContext, PluginHost

"""
åœ¨æ”¶åˆ°ç§èŠæˆ–ç¾¤èŠæ¶ˆæ¯"hello"æ—¶ï¼Œå›å¤"hello, <å‘é€è€…id>!"æˆ–"hello, everyone!"
"""


# æ³¨å†Œæ’ä»¶
@register(name="Hello", description="hello world", version="0.1", author="RockChinQ")
class HelloPlugin(Plugin):

    # æ’ä»¶åŠ è½½æ—¶è§¦å‘
    # plugin_host (pkg.plugin.host.PluginHost) æä¾›äº†ä¸ä¸»ç¨‹åºäº¤äº’çš„ä¸€äº›æ–¹æ³•ï¼Œè¯¦ç»†è¯·æŸ¥çœ‹å…¶æºç 
    def __init__(self, plugin_host: PluginHost):
        pass

    # æ’ä»¶å¸è½½æ—¶è§¦å‘
    def __del__(self):
        pass
```

</details>

2ï¸âƒ£ ç°åœ¨æˆ‘ä»¬å°†ä»¥ä¸‹å‡½æ•°æ·»åŠ åˆ°åˆšåˆšåˆ é™¤çš„å‡½æ•°çš„ä½ç½®

```Python

# è¦æ·»åŠ çš„å‡½æ•°

@func(name="access_the_web")  # è®¾ç½®å‡½æ•°åç§°
def _(url: str):
    """Call this function to search about the question before you answer any questions.
    - Do not search through baidu.com at any time.
    - If you need to search somthing, visit https://www.google.com/search?q=xxx.
    - If user ask you to open a url (start with http:// or https://), visit it directly.
    - Summary the plain content result by yourself, DO NOT directly output anything in the result you got.

    Args:
        url(str): url to visit

    Returns:
        str: plain text content of the web page
    """
    import requests
    from bs4 import BeautifulSoup
    # ä½ éœ€è¦å…ˆä½¿ç”¨
    # pip install beautifulsoup4
    # å®‰è£…ä¾èµ–

    r = requests.get(
        url,
        timeout=10,
        headers={
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36 Edg/115.0.1901.183"
        }
    )
    soup = BeautifulSoup(r.text, 'html.parser')

    s = soup.get_text()

    # åˆ é™¤å¤šä½™çš„ç©ºè¡Œæˆ–ä»…æœ‰\tå’Œç©ºæ ¼çš„è¡Œ
    s = re.sub(r'\n\s*\n', '\n', s)

    if len(s) >= 512:  # æˆªå–è·å–åˆ°çš„ç½‘é¡µçº¯æ–‡æœ¬å†…å®¹çš„å‰512ä¸ªå­—
        return s[:512]

    return s

```
<details>
<summary>ç°åœ¨è¿™ä¸ªæ–‡ä»¶å†…å®¹åº”è¯¥æ˜¯è¿™æ ·</summary>

```python
from pkg.plugin.models import *
from pkg.plugin.host import EventContext, PluginHost

"""
åœ¨æ”¶åˆ°ç§èŠæˆ–ç¾¤èŠæ¶ˆæ¯"hello"æ—¶ï¼Œå›å¤"hello, <å‘é€è€…id>!"æˆ–"hello, everyone!"
"""


# æ³¨å†Œæ’ä»¶
@register(name="Hello", description="hello world", version="0.1", author="RockChinQ")
class HelloPlugin(Plugin):

    # æ’ä»¶åŠ è½½æ—¶è§¦å‘
    # plugin_host (pkg.plugin.host.PluginHost) æä¾›äº†ä¸ä¸»ç¨‹åºäº¤äº’çš„ä¸€äº›æ–¹æ³•ï¼Œè¯¦ç»†è¯·æŸ¥çœ‹å…¶æºç 
    def __init__(self, plugin_host: PluginHost):
        pass

    @func(name="access_the_web")
    def _(url: str):
        """Call this function to search about the question before you answer any questions.
        - Do not search through baidu.com at any time.
        - If you need to search somthing, visit https://www.google.com/search?q=xxx.
        - If user ask you to open a url (start with http:// or https://), visit it directly.
        - Summary the plain content result by yourself, DO NOT directly output anything in the result you got.

        Args:
            url(str): url to visit

        Returns:
            str: plain text content of the web page
        """
        import requests
        from bs4 import BeautifulSoup
        # ä½ éœ€è¦å…ˆä½¿ç”¨
        # pip install beautifulsoup4
        # å®‰è£…ä¾èµ–

        r = requests.get(
            url,
            timeout=10,
            headers={
                "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36 Edg/115.0.1901.183"
            }
        )
        soup = BeautifulSoup(r.text, 'html.parser')

        s = soup.get_text()

        # åˆ é™¤å¤šä½™çš„ç©ºè¡Œæˆ–ä»…æœ‰\tå’Œç©ºæ ¼çš„è¡Œ
        s = re.sub(r'\n\s*\n', '\n', s)

        if len(s) >= 512:  # æˆªå–è·å–åˆ°çš„ç½‘é¡µçº¯æ–‡æœ¬å†…å®¹çš„å‰512ä¸ªå­—
            return s[:512]

        return s

    # æ’ä»¶å¸è½½æ—¶è§¦å‘
    def __del__(self):
        pass
```

</details>

#### è¯·æ³¨æ„ï¼š

- å‡½æ•°çš„æ³¨é‡Šå¿…é¡»ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„æ ¼å¼è¿›è¡Œä¹¦å†™ï¼Œå…·ä½“æ ¼å¼è¯·æŸ¥çœ‹[æ­¤æ–‡æ¡£](https://github.com/RockChinQ/CallingGPT/wiki/1.-Function-Format#function-format)
- å†…å®¹å‡½æ•°å’Œ`ä»¥@onè£…é¥°çš„è¡Œä¸ºå‡½æ•°`å¯ä»¥åŒæ—¶å­˜åœ¨äºåŒä¸€ä¸ªæ’ä»¶ï¼Œå¹¶åŒæ—¶å—åˆ°`switch.json`ä¸­çš„æ’ä»¶å¼€å…³çš„æ§åˆ¶
- åŠ¡å¿…ç¡®ä¿æ‚¨ä½¿ç”¨çš„æ¨¡å‹æ”¯æŒå‡½æ•°è°ƒç”¨åŠŸèƒ½ï¼Œå¯ä»¥åˆ°`config.py`çš„`completion_api_params`ä¸­ä¿®æ”¹æ¨¡å‹ï¼Œæ¨èä½¿ç”¨`gpt-3.5-turbo-16k`

3ï¸âƒ£ ç°åœ¨æ‚¨çš„ç¨‹åºå·²å…·å¤‡ç½‘ç»œè®¿é—®åŠŸèƒ½ï¼Œé‡å¯ç¨‹åºï¼Œè¯¢é—®æœºå™¨äººæœ‰å…³åœ¨çº¿çš„å†…å®¹æˆ–ç›´æ¥å‘é€æ–‡ç« é“¾æ¥è¯·æ±‚å…¶æ€»ç»“ã€‚

- è¿™ä»…ä»…æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œéœ€è¦æ›´é«˜æ•ˆçš„ç½‘ç»œè®¿é—®èƒ½åŠ›æ”¯æŒæ’ä»¶ï¼Œè¯·æŸ¥çœ‹[WebwlkrPlugin](https://github.com/RockChinQ/WebwlkrPlugin)

## ğŸ”’ç‰ˆæœ¬è¦æ±‚

è‹¥æ‚¨çš„æ’ä»¶å¯¹ä¸»ç¨‹åºçš„ç‰ˆæœ¬æœ‰è¦æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°è¿›è¡Œæ–­è¨€ï¼Œè‹¥ä¸ç¬¦åˆç‰ˆæœ¬ï¼Œæ­¤å‡½æ•°å°†æŠ¥é”™å¹¶æ‰“æ–­æ­¤å‡½æ•°æ‰€åœ¨çš„æµç¨‹ï¼š

```python
require_ver("v2.5.1")  # è¦æ±‚æœ€ä½ç‰ˆæœ¬ä¸º v2.5.1
```

```python
require_ver("v2.5.1", "v2.6.0")  # è¦æ±‚æœ€ä½ç‰ˆæœ¬ä¸º v2.5.1, åŒæ—¶è¦æ±‚æœ€é«˜ç‰ˆæœ¬ä¸º v2.6.0
```

- æ­¤å‡½æ•°åœ¨ä¸»ç¨‹åº`v2.5.1`ä¸­åŠ å…¥
- æ­¤å‡½æ•°å£°æ˜åœ¨`pkg.plugin.models`æ¨¡å—ä¸­ï¼Œåœ¨æ’ä»¶ç¤ºä¾‹ä»£ç æœ€å‰æ–¹å·²å¼•å…¥æ­¤æ¨¡å—æ‰€æœ‰å†…å®¹ï¼Œæ•…å¯ç›´æ¥ä½¿ç”¨

## ğŸ“„APIå‚è€ƒ

### è¯´æ˜

äº‹ä»¶å¤„ç†å‡½æ•°å°†ä¼šè·å¾—ä¸€ç³»åˆ—å‚æ•°ï¼Œå¯ä»¥åœ¨`kwargs`ä¸­å–å‡ºã€‚  
å…¶ä¸­`host`å‚æ•°ï¼ˆ`pkg.plugin.host.PluginHost`ç±»çš„å®ä¾‹ï¼‰æ˜¯æ’ä»¶å®¿ä¸»ï¼Œæä¾›ä¸ä¸»ç¨‹åºå„ä¸ªæ¨¡å—äº¤äº’çš„ä¸€äº›æ–¹æ³•ã€‚  
`event`å‚æ•°ï¼ˆ`pkg.plugin.host.EventContext`ç±»çš„å®ä¾‹ï¼‰æ˜¯äº‹ä»¶æ‰§è¡ŒæœŸé—´çš„ä¸Šä¸‹æ–‡ï¼Œæä¾›å¯¹æ­¤æ¬¡äº‹ä»¶æ‰§è¡Œçš„ä¸€äº›æ“ä½œæ–¹æ³•ã€‚  

äº‹ä»¶è¿”å›å€¼å‡ä¸º**å¯é€‰**çš„ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨`event.add_return(key: str, ret)`æ¥æäº¤è¿”å›å€¼

### äº‹ä»¶

æ‰€æœ‰äº‹ä»¶å‚æ•°å‡æœ‰`host`å’Œ`event`ï¼Œä»¥ä¸‹ä»…å±•ç¤ºå…¶ä»–å‚æ•°  
å…³äº`YiriMirai`æ”¯æŒçš„æ¶ˆæ¯é“¾ç»„ä»¶ï¼Œè¯·æŸ¥çœ‹ [YiriMiraiçš„æ–‡æ¡£](https://yiri-mirai.wybxc.cc/docs/basic/message-chain)

```Python
PersonMessageReceived = "person_message_received"
"""æ”¶åˆ°ç§èŠæ¶ˆæ¯æ—¶ï¼Œåœ¨åˆ¤æ–­æ˜¯å¦åº”è¯¥å“åº”å‰è§¦å‘
    kwargs:
        launcher_type: str å‘èµ·å¯¹è±¡ç±»å‹(group/person)
        launcher_id: int å‘èµ·å¯¹è±¡ID(ç¾¤å·/QQå·)
        sender_id: int å‘é€è€…ID(QQå·)
        message_chain: mirai.models.message.MessageChain æ¶ˆæ¯é“¾
"""

GroupMessageReceived = "group_message_received"
"""æ”¶åˆ°ç¾¤èŠæ¶ˆæ¯æ—¶ï¼Œåœ¨åˆ¤æ–­æ˜¯å¦åº”è¯¥å“åº”å‰è§¦å‘ï¼ˆæ‰€æœ‰ç¾¤æ¶ˆæ¯ï¼‰
    kwargs:
        launcher_type: str å‘èµ·å¯¹è±¡ç±»å‹(group/person)
        launcher_id: int å‘èµ·å¯¹è±¡ID(ç¾¤å·/QQå·)
        sender_id: int å‘é€è€…ID(QQå·)
        message_chain: mirai.models.message.MessageChain æ¶ˆæ¯é“¾
"""

PersonNormalMessageReceived = "person_normal_message_received"
"""åˆ¤æ–­ä¸ºåº”è¯¥å¤„ç†çš„ç§èŠæ™®é€šæ¶ˆæ¯æ—¶è§¦å‘
    kwargs:
        launcher_type: str å‘èµ·å¯¹è±¡ç±»å‹(group/person)
        launcher_id: int å‘èµ·å¯¹è±¡ID(ç¾¤å·/QQå·)
        sender_id: int å‘é€è€…ID(QQå·)
        text_message: str æ¶ˆæ¯æ–‡æœ¬
        
    returns (optional):
        alter: str ä¿®æ”¹åçš„æ¶ˆæ¯æ–‡æœ¬
        reply: list å›å¤æ¶ˆæ¯ç»„ä»¶åˆ—è¡¨ï¼Œå…ƒç´ ä¸ºYiriMiraiæ”¯æŒçš„æ¶ˆæ¯ç»„ä»¶
"""

PersonCommandSent = "person_command_sent"
"""åˆ¤æ–­ä¸ºåº”è¯¥å¤„ç†çš„ç§èŠæŒ‡ä»¤æ—¶è§¦å‘
    kwargs:
        launcher_type: str å‘èµ·å¯¹è±¡ç±»å‹(group/person)
        launcher_id: int å‘èµ·å¯¹è±¡ID(ç¾¤å·/QQå·)
        sender_id: int å‘é€è€…ID(QQå·)
        command: str æŒ‡ä»¤
        params: list[str] å‚æ•°åˆ—è¡¨
        text_message: str å®Œæ•´æŒ‡ä»¤æ–‡æœ¬
        is_admin: bool æ˜¯å¦ä¸ºç®¡ç†å‘˜
    
    returns (optional):
        alter: str ä¿®æ”¹åçš„å®Œæ•´æŒ‡ä»¤æ–‡æœ¬
        reply: list å›å¤æ¶ˆæ¯ç»„ä»¶åˆ—è¡¨ï¼Œå…ƒç´ ä¸ºYiriMiraiæ”¯æŒçš„æ¶ˆæ¯ç»„ä»¶
"""

GroupNormalMessageReceived = "group_normal_message_received"
"""åˆ¤æ–­ä¸ºåº”è¯¥å¤„ç†çš„ç¾¤èŠæ™®é€šæ¶ˆæ¯æ—¶è§¦å‘
    kwargs:
        launcher_type: str å‘èµ·å¯¹è±¡ç±»å‹(group/person)
        launcher_id: int å‘èµ·å¯¹è±¡ID(ç¾¤å·/QQå·)
        sender_id: int å‘é€è€…ID(QQå·)
        text_message: str æ¶ˆæ¯æ–‡æœ¬
        
    returns (optional):
        alter: str ä¿®æ”¹åçš„æ¶ˆæ¯æ–‡æœ¬
        reply: list å›å¤æ¶ˆæ¯ç»„ä»¶åˆ—è¡¨ï¼Œå…ƒç´ ä¸ºYiriMiraiæ”¯æŒçš„æ¶ˆæ¯ç»„ä»¶
"""

GroupCommandSent = "group_command_sent"
"""åˆ¤æ–­ä¸ºåº”è¯¥å¤„ç†çš„ç¾¤èŠæŒ‡ä»¤æ—¶è§¦å‘
    kwargs:
        launcher_type: str å‘èµ·å¯¹è±¡ç±»å‹(group/person)
        launcher_id: int å‘èµ·å¯¹è±¡ID(ç¾¤å·/QQå·)
        sender_id: int å‘é€è€…ID(QQå·)
        command: str æŒ‡ä»¤
        params: list[str] å‚æ•°åˆ—è¡¨
        text_message: str å®Œæ•´æŒ‡ä»¤æ–‡æœ¬
        is_admin: bool æ˜¯å¦ä¸ºç®¡ç†å‘˜
    
    returns (optional):
        alter: str ä¿®æ”¹åçš„å®Œæ•´æŒ‡ä»¤æ–‡æœ¬
        reply: list å›å¤æ¶ˆæ¯ç»„ä»¶åˆ—è¡¨ï¼Œå…ƒç´ ä¸ºYiriMiraiæ”¯æŒçš„æ¶ˆæ¯ç»„ä»¶
"""

NormalMessageResponded = "normal_message_responded"
"""è·å–åˆ°å¯¹æ™®é€šæ¶ˆæ¯çš„æ–‡å­—å“åº”æ—¶è§¦å‘
    kwargs:
        launcher_type: str å‘èµ·å¯¹è±¡ç±»å‹(group/person)
        launcher_id: int å‘èµ·å¯¹è±¡ID(ç¾¤å·/QQå·)
        sender_id: int å‘é€è€…ID(QQå·)
        session: pkg.openai.session.Session ä¼šè¯å¯¹è±¡
        prefix: str å›å¤æ–‡å­—æ¶ˆæ¯çš„å‰ç¼€
        response_text: str å“åº”æ–‡æœ¬
        finish_reason: str å“åº”ç»“æŸåŸå› 
    
    returns (optional):
        prefix: str ä¿®æ”¹åçš„å›å¤æ–‡å­—æ¶ˆæ¯çš„å‰ç¼€
        reply: list æ›¿æ¢å›å¤æ¶ˆæ¯ç»„ä»¶åˆ—è¡¨
"""

SessionFirstMessageReceived = "session_first_message_received"
"""ä¼šè¯è¢«ç¬¬ä¸€æ¬¡äº¤äº’æ—¶è§¦å‘
    kwargs:
        session_name: str ä¼šè¯åç§°(<launcher_type>_<launcher_id>)
        session: pkg.openai.session.Session ä¼šè¯å¯¹è±¡
        default_prompt: str é¢„è®¾å€¼
"""

SessionExplicitReset = "session_reset"
"""ä¼šè¯è¢«ç”¨æˆ·æ‰‹åŠ¨é‡ç½®æ—¶è§¦å‘ï¼Œæ­¤äº‹ä»¶ä¸æ”¯æŒé˜»æ­¢é»˜è®¤è¡Œä¸º
    kwargs:
        session_name: str ä¼šè¯åç§°(<launcher_type>_<launcher_id>)
        session: pkg.openai.session.Session ä¼šè¯å¯¹è±¡
"""

SessionExpired = "session_expired"
"""ä¼šè¯è¿‡æœŸæ—¶è§¦å‘
    kwargs:
        session_name: str ä¼šè¯åç§°(<launcher_type>_<launcher_id>)
        session: pkg.openai.session.Session ä¼šè¯å¯¹è±¡
        session_expire_time: int å·²è®¾ç½®çš„ä¼šè¯è¿‡æœŸæ—¶é—´(ç§’)   
"""

KeyExceeded = "key_exceeded"
"""api-keyè¶…é¢æ—¶è§¦å‘
    kwargs:
        key_name: str è¶…é¢çš„api-keyåç§°
        usage: dict è¶…é¢çš„api-keyä½¿ç”¨æƒ…å†µ
        exceeded_keys: list[str] è¶…é¢çš„api-keyåˆ—è¡¨
"""

KeySwitched = "key_switched"
"""api-keyè¶…é¢åˆ‡æ¢æˆåŠŸæ—¶è§¦å‘ï¼Œæ­¤äº‹ä»¶ä¸æ”¯æŒé˜»æ­¢é»˜è®¤è¡Œä¸º
    kwargs:
        key_name: str åˆ‡æ¢æˆåŠŸçš„api-keyåç§°
        key_list: list[str] api-keyåˆ—è¡¨
"""

PromptPreProcessing = "prompt_pre_processing"  # äºv2.5.1åŠ å…¥
"""æ¯å›åˆè°ƒç”¨æ¥å£å‰å¯¹promptè¿›è¡Œé¢„å¤„ç†æ—¶è§¦å‘ï¼Œæ­¤äº‹ä»¶ä¸æ”¯æŒé˜»æ­¢é»˜è®¤è¡Œä¸º
    kwargs:
        session_name: str ä¼šè¯åç§°(<launcher_type>_<launcher_id>)
        default_prompt: list æ­¤sessionä½¿ç”¨çš„æƒ…æ™¯é¢„è®¾å†…å®¹
        prompt: list æ­¤sessionç°æœ‰çš„promptå†…å®¹
        text_message: str ç”¨æˆ·å‘é€çš„æ¶ˆæ¯æ–‡æœ¬
    
    returns (optional):
        default_prompt: list ä¿®æ”¹åçš„æƒ…æ™¯é¢„è®¾å†…å®¹
        prompt: list ä¿®æ”¹åçš„promptå†…å®¹
        text_message: str ä¿®æ”¹åçš„æ¶ˆæ¯æ–‡æœ¬
"""
```

### host: PluginHost è¯¦è§£

æä¾›ä¸ä¸»ç¨‹åºå„ä¸ªæ¨¡å—äº¤äº’çš„ä¸€äº›æ–¹æ³•,å…·ä½“æŸ¥çœ‹`pkg.plugin.host`ä¸­çš„`PluginHost`ç±»  

### event: EventContext è¯¦è§£

æä¾›å¯¹æ­¤æ¬¡äº‹ä»¶æ‰§è¡Œçš„ä¸€äº›æ“ä½œæ–¹æ³•,å…·ä½“æŸ¥çœ‹`pkg.plugin.host`ä¸­çš„`EventContext`ç±»
